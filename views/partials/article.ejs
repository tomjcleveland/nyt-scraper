<div class="pill-box">
  <div class="pill">
    <strong><%= ordinal(article.rank) %></strong>-most viewed
  </div>
</div>

<% const headlinesSorted = article.headlines.sort((a, b) => b.count - a.count); %>
<% const topHeadline = headlinesSorted[0]; %>
<p><%= topHeadline.abstract %> <a href="<%= article.url %>">Read full article</a></p>
<div class="headline-details">
  <p><em>Print headline: <%= article.printheadline || article.canonicalheadline %></em></p>
  <% if (headlinesSorted.length > 1) { %>
    <h4 style="margin: 0;">A/B tested headlines (incidence)</h4>
    <ol>
      <% headlinesSorted.forEach((headline, i) => { %>
        <li>
          <strong style="color: <%- COLORS.FULL[i % COLORS.FULL.length] %>;"><%= headline.headline %></strong> (<%= headline.pct %>%)
        </li>
      <% }) %>
    </ol>
  <% } %>
  <% if (article.timeSeries) { %>
    <h4 style="margin-top: 8px;">Incidence over time</h4>
    <% const chartId = `chart-${encodeURIComponent(article.canonicalheadline)}`; %>
    <div class="aspect aspect-16-9">
      <div class="aspect-contents" id="<%= chartId %>"></div>  
    </div>
    <script>
      (() => {
        const timeSeries = JSON.parse('<%- JSON.stringify(article.timeSeries); %>');
        const headlines = JSON.parse('<%- JSON.stringify(article.headlines.map((hi) => hi.headline)); %>');
        const hasRanks = timeSeries.map(t => t.rank).filter(r => !!r).length !== 0;

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(drawChart);

        // Callback that creates and populates a data table,
        // instantiates the pie chart, passes in the data and
        // draws it.
        function drawChart() {

          // Create the data table.
          // Rows: Periods
          // Columns: [...Headlines, Rank]
          var data = new google.visualization.DataTable();
          const valuesByDate = {};
          for (let i = 0; i < headlines.length; i++) {
            const headline = headlines[i];
            for (const point of timeSeries.filter((t) => t.headline === headline)) {
              let currValues = valuesByDate[point.minute];
              if (!currValues || currValues.length === 0) {
                currValues = [];
                let arrLength = headlines.length;
                while (arrLength--) currValues.push(0);
                if (hasRanks) {
                  currValues.push(Number.isNaN(parseInt(point.rank, 10)) ? null : -1 * parseInt(point.rank, 10));
                }
              }
              currValues[i] = Math.round(100 * (point.count / point.total));
              valuesByDate[point.minute] = currValues;
            }
          }
          const rows = [];
          for (let key in valuesByDate) {
            const row = [new Date(key), ...valuesByDate[key]];
            rows.push(row);
          }
          const arr = [['Period', ...headlines], ...rows.sort((a, b) => a[0] - b[0])];
          if (hasRanks) {
            arr[0].push('Ranks');
          }
          var data = new google.visualization.arrayToDataTable(arr);

          // Set chart options
          var options = {
            width: '100%',
            legend: { position: "none" },
            bar: {groupWidth: "95%"},
            colors: window.COLORS.FULL,
            isStacked: true,
            vAxes: [
              { format: "#'%'", title: 'Headline distribution' }
            ],
            chartArea: {
              height: '80%'
            },
            series: {
              [headlines.length]: {
                type: 'line',
                targetAxisIndex: 1,
                pointSize: 5,
                color: '#000000'
              }
            }
          };
          if (hasRanks) {
            let ticks = [];
            for (let i = 1; i <= 20; i++) {
              ticks.push({v: -1 * i, f: i.toString()});
            }
            options.vAxes.push({ ticks, title: 'Rank (by views)' });
          }

          // Instantiate and draw our chart, passing in some options.
          var chart = new google.visualization.ColumnChart(document.getElementById('<%- chartId %>'));
          chart.draw(data, options);
        }
      })();
    </script>
  <% } %>
  <small><code><%= article.uri %></code></small>
</div>
<br>
