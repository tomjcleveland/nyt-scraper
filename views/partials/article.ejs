<% const headlinesSorted = article.headlines.sort((a, b) => b.count - a.count); %>
<% const topHeadline = headlinesSorted[0]; %>
<h3>
  <a href="<%= topHeadline.url %>">
    <%= topHeadline.headline %>
  </a>
</h3>
<div class="headline-details">
  <p><%= topHeadline.abstract %></p>
  <% if (headlinesSorted.length > 1) { %>
    <p><em>A/B tested headlines (incidence)</em></p>
    <ol>
      <% headlinesSorted.forEach((headline) => { %>
        <li>
          <strong><%= headline.headline %></strong> (<%= headline.pct %>%)
        </li>
      <% }) %>
    </ol>
  <% } %>
  <% if (article.timeSeries) { %>
    <h4 style="margin-bottom: 8px;">Incidence over time</h4>
    <% const chartId = `chart-${encodeURIComponent(article.canonicalHeadline)}`; %>
    <canvas id="<%= chartId %>" width="800" height="400"></canvas>
    <script>
      (() => {
        const COLORS = [
          'rgba(59, 130, 246, 0.2)', // Blue 500
          'rgba(16, 185, 129, 0.2)', // Green 500
          'rgba(139, 92, 246, 0.2)', // Purple 500
          'rgba(245, 158, 11, 0.2)', // Yellow 500
          'rgba(236, 72, 153, 0.2)', // Pink 500
          'rgba(239, 68, 68, 0.2)', // Red 500
        ];
        const timeSeries = JSON.parse('<%- JSON.stringify(article.timeSeries); %>');
        const headlines = JSON.parse('<%- JSON.stringify(article.headlines.map((hi) => hi.headline)); %>');
        const ctx = document.getElementById('<%= chartId %>').getContext('2d');
        const datasets = headlines.map((headline, i) => {
            return {
              label: headline,
              backgroundColor: COLORS[i % COLORS.length],
              data: timeSeries
                .filter((t) => t.headline === headline)
                .map(t => {
                  return {
                      x: new Date(t.minute),
                      y: Math.round(100 * (t.count / t.total)),
                    }
                })
            }
          });
        const myChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets,
          },
          options: {
            scales: {
              xAxes: [{
                type: 'time',
                time: {
                  unit: 'hour'
                },
              }],
              yAxes: [{
                ticks: {
                    suggestedMin: 0,
                    suggestedMax: 100,
                    callback: (v) => `${v}%`,
                }
              }]
            }
          }
        });
      })();
    </script>
  <% } %>
  <small><code><%= article.uri %></code></small>
</div>
<br>
